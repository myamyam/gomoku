<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ® Gomoku Lobby</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>ğŸ® Gomoku Lobby</h1>

  <div id="room-list" class="room-list">
    <div class="empty-msg">í˜„ì¬ ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ˜´</div>
  </div>

  <button onclick="createRoom()" class="create-btn">ìƒˆ ë°© ë§Œë“¤ê¸°</button>

  <script>
    let ws;
    let pendingNickname = null; // ë‹‰ë„¤ì„ ê¸°ì–µìš©

    window.onload = function() {
      ws = new WebSocket("ws://localhost:5000");

      ws.onopen = () => {
        console.log("âœ… ì„œë²„ ì—°ê²° ì™„ë£Œ");
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        // ğŸ”¹ ìƒˆ ë°© ìƒì„± í›„ ìë™ ì´ë™
        if (msg.type === "ROOM_CREATED") {
          const roomId = msg.data.room_id;
          console.log("ğŸ†• ë°© ìƒì„±ë¨:", roomId);
          // ë°©ì´ ìƒì„±ë˜ë©´ game.htmlë¡œ ì´ë™ (Player1ìœ¼ë¡œ)
          window.location.href = `game.html?room=${roomId}&role=player&nick=${encodeURIComponent(pendingNickname)}`;
        }

        // ğŸ”¹ ì‹¤ì‹œê°„ ë°© ë¦¬ìŠ¤íŠ¸ ìˆ˜ì‹ 
        if (msg.type === "ROOM_LIST") {
          renderRoomList(msg.data.rooms);
        }
      };
    };

    // âœ… ë°© ë§Œë“¤ê¸° (ë‹‰ë„¤ì„ ì…ë ¥ â†’ ì„œë²„ ì „ì†¡ â†’ ìë™ ì´ë™)
    function createRoom() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        alert("ì„œë²„ ì—°ê²°ì´ ì•ˆ ë˜ì–´ ìˆìŠµë‹ˆë‹¤!");
        return;
      }

      const nickname = prompt("í”Œë ˆì´ì–´ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”:", "Player1") || "Player1";
      pendingNickname = nickname;

      ws.send(JSON.stringify({ type: "CREATE_ROOM", data: { nickname: nickname } }));
      setTimeout(() => {
        ws.close();
      }, 200);
    }

    // âœ… ë°© ëª©ë¡ ë Œë”ë§
    function renderRoomList(rooms) {
      const listDiv = document.getElementById("room-list");
      listDiv.innerHTML = "";

      if (!rooms || rooms.length === 0) {
        const empty = document.createElement("div");
        empty.textContent = "í˜„ì¬ ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤ ğŸ˜´";
        empty.className = "empty-msg";
        listDiv.appendChild(empty);
        return;
      }

      rooms.forEach(r => {
        const row = document.createElement("div");
        row.className = "room-row";

        const info = document.createElement("span");
        info.textContent = `${r.room_id} (${r.players}/2)`;

        const joinBtn = document.createElement("button");
        joinBtn.textContent = "ì…ì¥";
        joinBtn.className = "room-btn";
        if (r.players < 2) {
          joinBtn.onclick = () => joinRoom(r.room_id, "player");
        } else {
          joinBtn.disabled = true;
          joinBtn.classList.add("disabled");
        }

        const spectateBtn = document.createElement("button");
        spectateBtn.textContent = "ê´€ì „í•˜ê¸° ğŸ‘ï¸";
        spectateBtn.className = "spectate-btn";
        spectateBtn.onclick = () => joinRoom(r.room_id, "spectator");

        row.appendChild(info);
        row.appendChild(joinBtn);
        row.appendChild(spectateBtn);

        listDiv.appendChild(row);
      });
    }

    // âœ… ë°© ì…ì¥
    function joinRoom(roomId, role) {
      const nickname = prompt(role === "spectator" ? "ê´€ì „ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:" : "ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”:") ||
                       (role === "spectator" ? "ê´€ì „ì" : "í”Œë ˆì´ì–´");

      ws.send(JSON.stringify({
        type: "JOIN_ROOM",
        data: { room_id: roomId, role: role, nickname: nickname }
      }));

      setTimeout(() => ws.close(), 150);
      window.location.href = `game.html?room=${roomId}&role=${role}&nick=${encodeURIComponent(nickname)}`;
    }
  </script>
</body>
</html>