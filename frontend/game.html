<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ•¹ï¸ Gomoku Game</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1 id="room-title">ğŸ•¹ï¸ Gomoku Game</h1>

    <!-- í”Œë ˆì´ì–´ ì´ë¦„/í„´ í‘œì‹œ -->
    <div class="players">
      <div class="player black-player" id="black-player">âš« í‘: ëŒ€ê¸°ì¤‘</div>
      <div class="player white-player" id="white-player">âšª ë°±: ëŒ€ê¸°ì¤‘</div>
    </div>

    <!-- ì˜¤ëª©íŒ -->
    <div id="board" class="board"></div>

    <!-- ì±„íŒ… -->
    <div class="chat">
      <div id="chat-log" class="chat-log"></div>
      <input id="chat-input" type="text" placeholder="ë©”ì‹œì§€ ì…ë ¥ í›„ Enter" />
    </div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get("room");
    const role = params.get("role");
    const nickname = params.get("nick");

    document.getElementById("room-title").textContent = `ğŸ•¹ï¸ ${roomId}`;

    const ws = new WebSocket("ws://localhost:5000");
    const boardEl = document.getElementById("board");
    const chatInput = document.getElementById("chat-input");
    const chatLog = document.getElementById("chat-log");
    const blackLabel = document.getElementById("black-player");
    const whiteLabel = document.getElementById("white-player");

    const SIZE = 15;
    let myStone = null;
    let currentTurn = null;
    let gameOver=false;

    const resultBox=document.createElement("div");
    resultBox.id="result-box"
    resultBox.style.textAlign="center"
    resultBox.style.marginTop="10px";
    resultBox.style.fontSize="20px";
    document.body.appendChild(resultBox);

    // ğŸ§± ì˜¤ëª©íŒ ê·¸ë¦¬ê¸°
    function drawBoard() {
      boardEl.innerHTML = "";

      for (let y = 0; y < SIZE; y++) {
        for (let x = 0; x < SIZE; x++) {
          const point = document.createElement("div");
          point.className = "point";
          point.dataset.x = x;
          point.dataset.y = y;
          if (role !== "spectator") {
            point.addEventListener("click", () => tryPlaceStone(x, y));
          }
          boardEl.appendChild(point);
        }
      }
    }
    drawBoard();

    // ğŸ§© ì°©ìˆ˜ ìš”ì²­
    function tryPlaceStone(x, y) {
      if (role === "spectator") return;
      if (myStone !== currentTurn) {
        alert("ì§€ê¸ˆì€ ë‹¹ì‹ ì˜ í„´ì´ ì•„ë‹™ë‹ˆë‹¤!");
        return;
      }
      ws.send(JSON.stringify({
        type: "MOVE",
        data: { room_id: roomId, x, y }
      }));
    }

    // ğŸ§© ì±„íŒ…
    chatInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && chatInput.value.trim() !== "") {
        ws.send(JSON.stringify({
          type: "CHAT",
          data: { room_id: roomId, msg: chatInput.value, sender: nickname }
        }));
        chatInput.value = "";
      }
    });

    // ğŸ§© ë©”ì‹œì§€ ìˆ˜ì‹ 
    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      const { type, data } = msg;
    
      if (type === "JOIN_SUCCESS") {
        if (data.role === "player") {
            myStone = data.stone;
            document.getElementById("player-info").textContent =
                `${nickname} (${myStone === "black" ? "âš« í‘" : "âšª ë°±"})`;
        }   else {
            document.getElementById("player-info").textContent = `${nickname} (ê´€ì „ì ğŸ‘ï¸)`;
        }
      }
      if(type==="BOARD_STATE"){
        // ê´€ì „ìëŠ” í˜„ì¬ ë³´ë“œ ìƒíƒœ ë°›ê¸°
        const board=data.board;
        for(let y=0;y<board.length;y++){
            for(let x=0;x<board[y].length;x++){
                const stone=board[y][x];
                const point=document.querySelector(`[data-x='${x}'][data-y='${y}']`);
                if(stone==="black"||stone==="white"){
                    document.querySelector(`[data-x='${x}'][data-y='${y}']`).classList.add(stone);
                }
            }
        }
      }
      if (type === "MOVE") {
        const { x, y, stone } = data;
        const point = document.querySelector(`[data-x="${x}"][data-y="${y}"]`);
        if (point && !point.classList.contains("black") && !point.classList.contains("white")) {
          point.classList.add(stone);
        }
      }

      if (type === "TURN") {
        currentTurn = data.next;
        updateTurnIndicator();
      }
      if(type==="GAME_OVER"){
        gameOver=true;
        const winColor=data.winner==="black"?"âš« í‘":"âšª ë°±";
        resultBox.innerHTML=`
            <h2>${winColor} ìŠ¹ë¦¬!</h2>
            <button id="restart-btn">ë‹¤ì‹œ í”Œë ˆì´í•˜ê¸°</button>
        `;
        document.getElementById("restart-btn").onclick=restartGame;
      }

      if (type === "CHAT") appendChat(`${data.sender}: ${data.msg}`);
      if (type === "SYSTEM") appendChat(`[SYSTEM] ${data.msg}`);
    };

    // ğŸ¯ í„´ í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateTurnIndicator() {
      blackLabel.classList.remove("active");
      whiteLabel.classList.remove("active");

      if (currentTurn === "black") {
        blackLabel.classList.add("active");
      } else {
        whiteLabel.classList.add("active");
      }
    }

    // ğŸ§  ì ‘ì† í›„ ì—­í•  í‘œì‹œ (í‘/ë°±/ê´€ì „ì)
    ws.onopen = () => {
      if (role === "player") {
        ws.send(JSON.stringify({ type: "JOIN_ROOM", data: { room_id: roomId, role: "player", nickname: nickname } }));
      } else if (role === "spectator") {
        ws.send(JSON.stringify({ type: "JOIN_ROOM", data: { room_id: roomId, role: "spectator", nickname: nickname } }));
      }
    };

    function appendChat(text) {
      const div = document.createElement("div");
      div.textContent = text;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    function restartGame(){
        gameOver=false;
        resultBox.innerHTML="";
        drawBoard();
    }
  </script>
</body>
</html>